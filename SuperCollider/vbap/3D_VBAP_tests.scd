s.reboot;

s.meter;
s.plotTree;
s.scope;
Server.default
(
s.options.numWireBufs = 128;
s.options.sampleRate = 48000;

//ServerOptions.outDevices;
//Server.default.options.inDevice_("MADIface USB (23628221)");
//Server.default.options.outDevice_("MADIface USB (23628221)");


Server.default.options.inDevice_("MADIface USB (23727305)");
Server.default.options.outDevice_("MADIface USB (23727305)");


s.options.numInputBusChannels = 2;
s.options.numOutputBusChannels = 64;
)

s.boot;

(//old, 0-90° elevation.
/*
~lspCoordinates = [[-16.61, 41.13], [31.75, 40.03], [-28.17, 27.21], [-1.73, 26.32], [23.04, 26.48], [-18.43, 9.16], [10.27, 8.74], [35.45, 8.77], [47.97, 28.26], [59.46, 8.80], [72.32, 20.65], [80.81, 35.60], [91.41, 8.77], [96.84, 28.85], [113.48, 27.16], [113.16, 39.38], [121.51, 8.84], [131.98, 34.75], [142.00, 9.47], [152.92, 28.77], [163.96, 15.13], [176.64, 28.39], [-176.85, 8.65], [-165.96, 36.40], [-153.80, 22.87], [-151.84, 8.82], [-144.78, 35.05], [-126.73, 9.17], [-126.70, 29.82], [-113.82, 39.76], [-107.87, 8.72], [-100.37, 28.39], [0, 86.17], [9.20, 46.48], [26.01, 71.09], [41.76, 52.26], [68.78, 71.77], [63.16, 42.57], [75.31, 57.02], [99.65, 45.78], [117.36, 70.54], [124.69, 55.25], [151.89, 49.13], [156.08, 64.52], [172.03, 41.07], [180, 77.86], [-169.48, 53.67], [-139.62, 46.16], [-135.33, 65.39], [-109.95, 54.01], [-90, 72.17], [-84.12, 50.31], [-58.36, 54.59], [-36.63, 70.72], [-29.83, 52.00], [-5.15, 59.65], [-88.23, 8.76], [-85.42, 33.14], [-69.14, 17.59], [-67.57, 37.69], [-51.57, 9.19], [-48.39, 27.17], [-48.24, 40.06]];
*/
//3D Sound Lab, 0° elevation auf etwa Augenhöhe beim sitzen
~lspCoordinates = [[16.61, 13.4], [-31.76, 13.11], [28.18, -6.58], [1.74, -6.34], [-23.05, -6.38], [18.43, -31.51], [-10.27, -30.29], [-35.46, -30.38], [-47.97, -2.8], [-59.46, -30.48], [-72.32, -14.11], [-80.81, 7.72], [-91.41, -30.38], [-96.84, -2.56], [-113.49, -8.08], [-113.16, 13.01], [-121.51, -30.59], [-131.99, 5.66], [-142.01, -27.63], [-152.93, -2.55], [-163.96, -22.79], [-176.65, -2.51], [176.86, -30.05], [165.96, 8.82], [153.81, -9.09], [151.84, -30.53], [144.78, 7.12], [126.73, -29.08], [126.7, -0.56], [113.82, 13.94], [107.88, -30.26], [100.38, -2.51], [0, 83.62], [-9.2, 21.38], [-26.02, 58.58], [-41.77, 31.35], [-68.78, 59.85], [-63.16, 15.72], [-75.31, 36.52], [-99.66, 21.73], [-117.37, 57.63], [-124.7, 34.34], [-151.89, 26.5], [-156.08, 48.86], [-172.03, 15.5], [-180, 69.99], [169.48, 33.16], [139.62, 22.77], [135.34, 49.98], [109.95, 33.37], [90, 60.83], [84.13, 27.61], [58.37, 33.68], [36.63, 58.4], [29.83, 28.9], [5.16, 41.3], [88.23, -30.38], [85.43, 3.14], [69.15, -19.31], [67.57, 10.53], [51.57, -31.59], [48.39, -8.88], [48.25, 13.51], [47.74, -25.52]];
)
(// WRF
//~lspCoordinates = [[43.79, 0], [35.27, 0], [25.63, 0], [14.09, 0], [0, 0], [-14.07, 0], [-25.70, 0], [-35.38, 0], [-43.93, 0], [-47.81, 0], [-55.18, 0], [-65.09, 0], [-76.87, 0], [-90, 0], [-103, 0], [-114.79, 0], [-124.72, 0], [-132.25, 0], [-138.80, 0], [-147.91, 0], [-159.71, 0], [-172.91, 0], [172.92, 0], [159.58, 0], [148.17, 0], [139.02, 0], [132.49, 0], [124.87, 0], [114.87, 0], [103.05, 0], [90, 0], [76.94, 0], [65.12, 0], [55.22, 0], [47.79, 0], [39.25, 30], [16.29, 30], [-16.29, 30], [-38.81, 30], [-60.75, 30], [-90, 30], [-118.75, 30], [-141.17, 30], [-163.71, 30], [163.71, 30], [140.75, 30], [118.75, 30], [90, 30], [60.75, 30], [40.83, 60], [0, 60], [-40.36, 60], [90, 60], [0, 90], [-90, 60], [139.16, 60], [-180, 60], [-139.63, 60]];
~lspCoordinates = [[43.79, 18.29], [35.27, 20.48], [25.63, 22.43], [14.09, 23.94], [0, 24.6], [-14.07, 23.94], [-25.70, 22.42], [-35.38, 20.46], [-43.93, 18.23], [-47.81, 17.09], [-55.18, 18.80], [-65.09, 20.26], [-76.87, 22], [-9, 22.53], [-103, 22.01], [-114.79, 20.63], [-124.72, 18.82], [-132.25, 17.06], [-138.80, 19], [-147.91, 21.19], [-159.71, 23.22], [-172.91, 24.44], [172.92, 24.42], [159.58, 23.20], [148.17, 21.23], [139.02, 19.04], [132.49, 17.13], [124.87, 18.87], [114.87, 20.70], [103.05, 22.090], [90, 22.62], [76.94, 22.09], [65.12, 20.70], [55.22, 18.88], [47.79, 17.13], [39.25, 35.81], [16.29, 41.81], [-16.29, 41.81], [-38.81, 35.99], [-60.75, 37.06], [-90, 40.88], [-118.75, 37.18], [-141.17, 35.99], [-163.71, 41.81], [163.71, 41.81], [140.75, 35.81], [118.75, 37.18], [90, 40.88], [60.75, 37.06], [40.83, 49.79], [0, 57.40], [-40.36, 49.99], [90, 61.08], [0, 90], [-90, 61.47], [139.16, 49.79], [-180, 57.40], [-139.63, 49.99]];

//VBAPSpeakerArray.maxNumSpeakers = 70;
a = VBAPSpeakerArray.new(3, ~lspCoordinates); //, [-47.74, 0]

"Create buffer... this will take some time...".postln;
b = Buffer.loadCollection(s, a.getSetsAndMatrices);
//a.numSpeakers;
)

(
SynthDef(\test, {|rate = 0.1| //
/*	var pan, snd, rotA, rotE, sr, min, exp;
	min = 0;//min auf minus werte setzen für glitches. sonst 0 lassen
	exp = 30;//exp je höher desto anstrengender. ab 40 wirds wild
	sr = SampleRate.ir;
	snd = WhiteNoise.ar * 0.1;//PlayBuf.ar(1, ~a);
	rotA = LinLin.kr(Phasor.ar(Impulse.ar(rate), rate / sr), 0, 1, -180, 180);
	rotE = LinLin.kr(SinOsc.kr(rate * exp), -1, 1, min, 90);
	pan = VBAP.ar(a.numSpeakers, snd, b.bufnum, rotA, 0, 0).postln * 0.2;
	Out.ar(0, pan);*/
	var x, y, z, azi, ele, dist, snd, pan, lag, amp;
	//azi = MouseX.kr(-180, 180);
	azi = SinOsc.kr(1/20).range(-180, 180);
	ele = MouseY.kr(0, 90);
	amp = 1;
	lag = 0.01;
	snd = WhiteNoise.ar(0.1);
	pan = VBAP.ar(a.numSpeakers, snd, b.bufnum, azi, ele, 20).postln * 0.2;
	Out.ar(0, pan);
}).add.play;
)
(
{
1.do{
	Synth(\test, [\rate, 0.1]);
	3.wait;
	Synth(\test, [\rate, 0.6]);
}}.fork;
)

Synth(\testLS);
(
g = (0..57);
h = Array.fill(57, 1);
h.insert(58, 0);
)

(
SynthDef(\testLS, {|rate = 0.1|
	var ls, snd, env;
	snd = WhiteNoise.ar * 0.01;
	env = EnvGen.kr(Env(g, h));
	Out.ar(0, snd);
}).add;
)